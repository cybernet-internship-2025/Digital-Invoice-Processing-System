<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="az.cybernet.invoice.repository.UserRepository">

    <resultMap id="UserResultMap" type="az.cybernet.invoice.dto.client.user.UserDto">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="password" column="password"/>
        <result property="isBlocked" column="is_blocked"/>
        <result property="failedAttempts" column="failed_attempts"/>
        <result property="blockedUntil" column="blocked_until"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="taxId" column="tax_id"/>
        <result property="mustChangePassword" column="must_change_password"/>
    </resultMap>

    <!-- userId veya taxId ile arama -->
    <select id="findByUserIdOrTaxId" parameterType="map" resultMap="UserResultMap">
        SELECT * FROM users
        WHERE user_id = #{userId} OR tax_id = #{taxId}
    </select>

    <update id="update" parameterType="az.cybernet.invoice.dto.client.user.UserDto">
        UPDATE users
        SET password=#{password},
        is_blocked=#{isBlocked},
        failed_attempts=#{failedAttempts},
        blocked_until=#{blockedUntil},
        phone_number=#{phoneNumber},
        must_change_password=#{mustChangePassword}
        WHERE id=#{id}
    </update>

    <insert id="save" parameterType="az.cybernet.invoice.dto.client.user.UserDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (user_id, password, is_blocked, failed_attempts, blocked_until, phone_number, tax_id, must_change_password)
        VALUES (#{userId}, #{password}, #{isBlocked}, #{failedAttempts}, #{blockedUntil}, #{phoneNumber}, #{taxId}, #{mustChangePassword})
    </insert>

</mapper>
