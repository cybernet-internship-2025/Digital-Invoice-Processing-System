<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="az.cybernet.invoice.repository.OperationRepository">

    <resultMap id="OperationEntityDetailsMap" type="az.cybernet.invoice.entity.OperationDetailsEntity">
        <association property="operation" javaType="az.cybernet.invoice.entity.OperationEntity">
            <id property="id" column="operation_id"/>
        </association>
        <association property="item" javaType="az.cybernet.invoice.entity.ItemEntity">
            <id property="id" column="item_id"/>
        </association>
        <result property="itemStatus" column="item_status" javaType="az.cybernet.invoice.enums.ItemStatus"/>

    </resultMap>

    <resultMap id="OperationEntityMap" type="az.cybernet.invoice.entity.OperationEntity">
        <id property="id" column="id"/>
        <result property="status" column="status" javaType="az.cybernet.invoice.enums.OperationStatus"/>
        <result property="createdAt" column="created_at"/>
        <association property="invoice" javaType="az.cybernet.invoice.entity.InvoiceEntity">
            <id property="id" column="invoice_id"/>
        </association>
        <collection property="itemDetails" ofType="az.cybernet.invoice.entity.OperationDetailsEntity" resultMap="OperationEntityDetailsMap"/>
    </resultMap>

    <insert id="save" parameterType="az.cybernet.invoice.entity.OperationEntity">
        INSERT INTO operations (status, created_at, invoice_id)
        VALUES (#{op.status}, #{op.createdAt}, #{op.invoice.id})
    </insert>

    <select id="findById" parameterType="long" resultMap="OperationEntityMap">
        SELECT
        o.id AS id,
        o.status AS status,
        o.created_at AS created_at,
        o.invoice_id AS invoice_id,
        od.operation_id AS operation_id,
        od.item_id AS item_id,
        od.item_status AS item_status
        -- od.comment AS comment -- SİLİNDİ
        FROM operations o
        LEFT JOIN operation_details od ON o.id = od.operation_id
        WHERE o.id = #{id}
    </select>

    <select id="findAll" resultMap="OperationEntityMap">
        SELECT
        o.id AS id,
        o.status AS status,
        o.created_at AS created_at,
        o.invoice_id AS invoice_id,
        od.operation_id AS operation_id,
        od.item_id AS item_id,
        od.item_status AS item_status

        FROM operations o
        LEFT JOIN operation_details od ON o.id = od.operation_id
    </select>

    <select id="findByStatus" parameterType="az.cybernet.invoice.enums.OperationStatus" resultMap="OperationEntityMap">
        SELECT
        o.id AS id,
        o.status AS status,
        o.created_at AS created_at,
        o.invoice_id AS invoice_id,
        od.operation_id AS operation_id,
        od.item_id AS item_id,
        od.item_status AS item_status
        -- od.comment AS comment -- SİLİNDİ
        FROM operations o
        LEFT JOIN operation_details od ON o.id = od.operation_id
        WHERE o.status = #{status}
    </select>

    <select id="findAllItemsById" parameterType="long" resultMap="OperationEntityMap">
        SELECT
        o.id AS id,
        o.status AS status,
        o.created_at AS created_at,
        o.invoice_id AS invoice_id,
        od.operation_id AS operation_id,
        od.item_id AS item_id,
        od.item_status AS item_status
        FROM operations o
        LEFT JOIN operation_details od ON o.id = od.operation_id
        WHERE od.item_id = #{itemId}
    </select>

    <select id="findAllInvoicesById" parameterType="long" resultMap="OperationEntityMap">
        SELECT
        o.id AS id,
        o.status AS status,
        o.created_at AS created_at,
        o.invoice_id AS invoice_id,
        od.operation_id AS operation_id,
        od.item_id AS item_id,
        od.item_status AS item_status
        FROM operations o
        LEFT JOIN operation_details od ON o.id = od.operation_id
        WHERE o.invoice_id = #{invoiceId}
    </select>

</mapper>
